<!DOCTYPE html>
<html style="overflow: hidden; margin: 0%; padding: 0%;">
<head>    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
        }
        #canvas-wrapper {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body style="overflow: hidden; margin: 0%; padding: 0%;">
    <div id="canvas-container" style="margin: 0%; padding: 0%; width: 100vw; height: 100vh;">
        <canvas id="c" width="800" height="600" style="display: block; margin: 0%; padding: 0%;"></canvas>
    </div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<script>
    const canvas = new fabric.Canvas('c', {
        selection: false, // Disable the blue group selection box globally
        hoverCursor: 'default',
        backgroundColor: '#000000'
    });

    // Game State
    let mdpCount = 0;
    const assets = {
        wolvey: null,
        storeItems: []
    };

    // UI Constants
    const COLORS = {
        leftBg: '#1a232e', // Dark Blue
        midBg: '#0d1218',  // Darker Blue/Black
        rightBg: '#1a232e', // Dark Blue
        text: '#ffffff',
        accent: '#66cdaa',
        storeHover: '#2a3542',
        storeBg: '#1a232e'
    };

    // --- OBJECT CREATION ---

    // 1. Background Panels (Visual separation)
    const panelMid = new fabric.Rect({ left: 0, top: 0, fill: COLORS.midBg, selectable: false, evented: false });
    const panelRight = new fabric.Rect({ left: 0, top: 0, fill: COLORS.rightBg, selectable: false, evented: false });
    // Divider lines
    const div2 = new fabric.Rect({ top: 0, width: 6, fill: 'rgba(0,0,0,0.5)', selectable: false, evented: false });

    canvas.add(panelMid, panelRight, div2);

    // 2. Score Text
    const scoreLabel = new fabric.Text('0 MDP Credits', {
        fontFamily: 'Comic Sans MS, Arial, sans-serif',
        fontSize: 40,
        fill: '#ffffff',
        textAlign: 'center',
        selectable: false,
        evented: false,
        shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.5)', blur: 10, offsetX: 2, offsetY: 2 })
    });
    const cpsLabel = new fabric.Text('per second: 0', {
        fontFamily: 'Arial, sans-serif',
        fontSize: 18,
        fill: '#aaaaaa',
        textAlign: 'center',
        selectable: false,
        evented: false
    });
    canvas.add(scoreLabel, cpsLabel);

    // 3. Store Title
    const storeTitle = new fabric.Text('STORE', {
        fontFamily: 'Arial, sans-serif',
        fontSize: 24,
        fontWeight: 'bold',
        fill: COLORS.accent,
        selectable: false,
        evented: false
    });
    canvas.add(storeTitle);

    // 4. Helper to create a Store Item Button
    function createStoreItem(name, price, iconEmoji, index) {
        const height = 80;
        const padding = 10;
        
        // Container Box
        const bg = new fabric.Rect({
            width: 280, // Will be resized in layout
            height: height - padding,
            fill: COLORS.storeBg,
            rx: 5, ry: 5,
            stroke: '#333',
            strokeWidth: 1
        });

        // Icon (Emoji is easier than loading 10 images for a demo)
        const icon = new fabric.Text(iconEmoji, {
            fontSize: 40,
            left: 10,
            top: 10
        });

        // Name
        const nameText = new fabric.Text(name, {
            fontFamily: 'Arial',
            fontSize: 20,
            fill: '#fff',
            left: 70,
            top: 10,
            fontWeight: 'bold'
        });

        // Price
        const priceText = new fabric.Text(`ðŸª ${price}`, {
            fontFamily: 'Arial',
            fontSize: 16,
            fill: '#66cdaa',
            left: 70,
            top: 35
        });

        // Group them
        const group = new fabric.Group([bg, icon, nameText, priceText], {
            left: 0, // Set in layout
            top: 0,  // Set in layout
            selectable: false, // LOCKED: User can't move the button
            hoverCursor: 'pointer',
            subTargetCheck: true,
            name: 'storeButton'
        });

        // Custom properties for logic
        group.origFill = COLORS.storeBg;
        
        // Add interaction
        group.on('mouseover', () => {
            bg.set('fill', COLORS.storeHover);
            canvas.requestRenderAll();
        });
        group.on('mouseout', () => {
            bg.set('fill', COLORS.storeBg);
            canvas.requestRenderAll();
        });
        group.on('mousedown', () => {
            bg.set('fill', '#444');
            canvas.requestRenderAll();
        });
        group.on('mouseup', () => {
            bg.set('fill', COLORS.storeHover);
            canvas.requestRenderAll();
        });

        assets.storeItems.push(group);
        canvas.add(group);
    }

    // Create some dummy store items
    createStoreItem("MEME1", 15, "ðŸ‘†", 0);
    createStoreItem("MEME2", 100, "ðŸ‘µ", 1);
    createStoreItem("MEME3", 1100, "ðŸšœ", 2);
    createStoreItem("MEME4", 12000, "â›ï¸", 3);
    createStoreItem("MEME5", 130000, "ðŸ­", 4);

    // --- LOAD MAIN ASSET ---

    const temp_img = new Image()
    temp_img.src = 'images.png'
    temp_img.onload = function() {
        // 3. Create Fabric Image from the native one
        const fImg = new fabric.Image(temp_img, {
            crossOrigin: "anonymous"
        });
        
        // 4. Run your setup logic
        setupMainClicker(fImg);
    };
    // 5. Safety Fallback: If image fails, draw a circle so game still works
    temp_img.onerror = function() {
        console.error("Image failed to load. Using fallback circle.");
        const fallback = new fabric.Circle({ radius: 100, fill: '#ffcc00', stroke: '#fff', strokeWidth: 5 });
        setupMainClicker(fallback);
    };

    // Using the generated image ID or a placeholder
    function setupMainClicker(fabricObj) {
        assets.wolvey = fabricObj;
        
        fabricObj.set({
            originX: 'center',
            originY: 'center',
            // === CRITICAL FIX: Ensure the object is enabled for mouse events ===
            evented: true,       
            selectable: false,
            hoverCursor: 'pointer',
            hasControls: false,
            lockMovementX: true,
            lockMovementY: true
        });

        // Click Interaction
        fabricObj.on('mousedown', function() {
            // Animate Shrink
            fabricObj.animate('scaleX', fabricObj.scaleX * 0.9, { duration: 50, onChange: canvas.renderAll.bind(canvas) });
            fabricObj.animate('scaleY', fabricObj.scaleY * 0.9, { duration: 50, onChange: canvas.renderAll.bind(canvas) });
            
            // Score Logic
            mdpCount++;
            scoreLabel.set('text', `${mdpCount} Credits`);
            
            // Spawn Floater
            spawnFloater("+1", fabricObj.left, fabricObj.top);
        });

        fabricObj.on('mouseup', function() {
            // Calculate correct return scale based on layout rules
            const w = canvas.width;
            const h = canvas.height;
            const leftW = w * 0.30;
            
            // Calculate the target size based on current layout
            const targetSize = Math.min(leftW, h) * 0.6;
            const objWidth = fabricObj.type === 'circle' ? fabricObj.radius * 2 : fabricObj.width; 
            const targetScale = targetSize / objWidth; 

            // Animate Back
            fabricObj.animate('scaleX', targetScale, { duration: 100, easing: fabric.util.ease.easeOutBounce, onChange: canvas.renderAll.bind(canvas) });
            fabricObj.animate('scaleY', targetScale, { duration: 100, easing: fabric.util.ease.easeOutBounce, onChange: canvas.renderAll.bind(canvas) });
        });

        canvas.add(assets.wolvey);
        renderLayout();
    }

    // --- UTILITIES ---

    // Floating text effect
    function spawnFloater(text, x, y) {
        const floater = new fabric.Text(text, {
            left: x, top: y - 50,
            fontFamily: 'Arial', fontSize: 24, fontWeight: 'bold', fill: '#fff',
            originX: 'center', originY: 'center',
            selectable: false, evented: false
        });
        canvas.add(floater);
        floater.animate('top', y - 150, { duration: 1000, onChange: canvas.renderAll.bind(canvas) });
        floater.animate('opacity', 0, { 
            duration: 1000, 
            onChange: canvas.renderAll.bind(canvas),
            onComplete: () => canvas.remove(floater)
        });
    }

    // --- RESPONSIVE LAYOUT ENGINE ---
    
    function renderLayout() {
        // 1. Get Dimensions
        const w = window.innerWidth;
        const h = window.innerHeight;
        
        // Resize Canvas
        canvas.setWidth(w);
        canvas.setHeight(h);

        // 2. Define Columns
        const leftW = w * 0.30;
        const midW = w * 0.45; // Leftover for middle
        const rightW = w * 0.25;
        
        // 3. Position Backgrounds
        panelMid.set({ width: midW + leftW, height: h });
        panelRight.set({ left: leftW + midW, width: rightW, height: h });
        
        div2.set({ left: leftW + midW, height: h });

        // 4. Position Cookie (Center of Left Panel)
        if(assets.wolvey) {
            const wolveySize = Math.min(leftW, h) * 0.6; // 60% of the smaller dimension
            const scale = wolveySize / assets.wolvey.width;
            assets.wolvey.set({
                left: (leftW + midW) / 2,
                top: h / 2,
                scaleX: scale,
                scaleY: scale
            });
            assets.wolvey.setCoords()
        }

        // 5. Position Score (Above Cookie)
        scoreLabel.set({
            left: (leftW + midW) / 2,
            originX: 'center',
            top: h * 0.15
        });
        cpsLabel.set({
            left: (leftW + midW) / 2,
            originX: 'center',
            top: h * 0.15 + 50
        });

        // 6. Position Store (Right Panel)
        storeTitle.set({
            left: (leftW + midW) + (rightW / 2),
            originX: 'center',
            top: 20
        });

        let currentY = 60;
        assets.storeItems.forEach((item) => {
            // Resize the background rect of the group to fit column
            const bgRect = item.getObjects()[0];
            const targetWidth = rightW - 20;
            
            // Note: modifying objects inside a group can be tricky in Fabric
            // We scale the whole group to fit the width approximately
            // Or we just center it. Let's Center it for simplicity.
            
            item.set({
                left: (leftW + midW) + (rightW / 2),
                top: currentY,
                originX: 'center',
                originY: 'top'
            });
            
            // Simple scale to fit if column is too small
            if (rightW < 300) {
                const scale = (rightW - 20) / 280;
                item.scale(scale);
            } else {
                item.scale(1);
            }

            // Increment Y based on item height (including scale)
            currentY += (item.height * item.scaleY) + 10;
        });

        canvas.requestRenderAll();
    }

    canvas.on('mouse:down', (e) => {
        console.log("Top object under cursor:", e.target);
    });


    // Listen to resize
    window.addEventListener('resize', renderLayout);
    renderLayout();
</script>
</html>